# Loading and Cleaning Data

1.  Load datasets
    i) Aviation Incident Data
    ii) Military Base Location Data - Shapefile
2.  Clean datasets
    i)  Verify tidy format
    ii) Join lat/long data
    iii) output clean datasets

*Note: All paths are local, configured to run from root directory (dsan6750final)*

## Load datasets

```{r}
library(tidyverse) |> suppressPackageStartupMessages()
library(sf) |> suppressPackageStartupMessages()
library(mapview) |> suppressPackageStartupMessages()
library(spatstat) |> suppressPackageStartupMessages()
library(jsonlite) |> suppressPackageStartupMessages()
library(lubridate) |> suppressPackageStartupMessages()
library(rnaturalearth) |> suppressPackageStartupMessages()
library(ggplot2)
library(tibble)
library(spatstat.geom)
library(webshot2)

```

## Loading data for military bases/incidents
```{r}
bases_sf <- st_read("data/raw/military_bases.geojson")

mapview(bases_sf)

```

Loading incident data
```{r}
cases_20to25 <- fromJSON("data/raw/cases2020-2025.json", flatten = TRUE)
cases_15to19 <- fromJSON("data/raw/cases2015-2019.json", flatten = TRUE)

# combine all incident data for 2015-2025
all_data <- bind_rows(cases_20to25, cases_15to19)
all_data_clean <- all_data |>
  filter(!is.na(cm_Latitude), !is.na(cm_Longitude), !is.na(cm_highestInjury)) |>
  select(-cm_vehicles) 

# sf points conversion
cases_sf <- st_as_sf(
  all_data_clean,
  coords = c("cm_Longitude", "cm_Latitude"),
  crs = 4326,
  remove = FALSE
)

mapview(cases_sf)
```

combined map
```{r}
# transform and make bases centroids
bases_3857  <- st_transform(bases_sf, 3857)
bases_valid <- st_make_valid(bases_3857)
bases_centroids <- st_centroid(bases_valid)

#transform cases
cases_3857 <- st_transform(cases_sf, 3857)

# only conus
us_states <- ne_states(country = "United States of America", returnclass = "sf")
conus <- us_states |>
  filter(!name %in% c("Alaska", "Hawaii", "Puerto Rico")) |> 
  st_union()

conus_3857 <- st_transform(conus, 3857)

# filter
cases_conus <- st_intersection(cases_3857, conus_3857)
bases_conus <- st_intersection(bases_centroids, conus_3857)


mapview(cases_conus) + mapview(bases_conus, col.regions="red")

```

Adjusted conus with buffer
```{r}
buffer_dist <- 1000000
conus_buffered_100km <- st_buffer(conus_3857, dist = buffer_dist)
conus_buffered_100km <- st_make_valid(conus_buffered_100km)


# filter
cases_conus <- st_intersection(cases_3857, conus_3857)
bases_conus <- st_intersection(bases_centroids, conus_3857)

mapview(cases_conus) + mapview(bases_conus, col.regions="red")

```

## Basic dataset statistics for incidents

Histogram of incidents 
```{r}
# date time conversion/columns
 all_data_dates <- all_data_clean |>
    mutate(
        event_date = ymd_hms(cm_eventDate),
        event_year = year(event_date),
        event_month = month(event_date, label = TRUE, abbr = TRUE)
    )

# histogram by year
ggplot(all_data_dates, aes(x = event_year)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  theme_classic() +
  labs(
    title = "Incidents per Year",
    x = "Year",
    y = "Count of Incidents"
  )

ggsave(
  "images/eda/incidents_yearly_histogram.png",
  width = 8,
  height = 6,
  dpi = 300
)


# histogram by month 
ggplot(all_data_dates, aes(x = event_month)) +
  geom_bar(fill = "steelblue", color = "white") +
  theme_classic() +
  labs(
    title = "Incidents per month (2015-2025)",
    x = "Month",
    y = "Count of Incidents"
  )

ggsave(
  "images/eda/incidents_monthly_histogram.png",
  width = 8,
  height = 6,
  dpi = 300
)

# heat map by year and month 
all_data_dates %>%
  count(event_year, event_month) |>
  ggplot(aes(x = event_month, y = factor(event_year), fill = n)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "C") +
  labs(
    title = "Incidents by Month and Year",
    x = "Month",
    y = "Year",
    fill = "Count"
  ) +
  theme_classic()

ggsave(
  "images/eda/year_month_heatmap.png",
  width = 8,
  height = 6,
  dpi = 300
)

# hist on year and mode
year_mode_counts <- all_data_dates |>
  count(event_year, cm_mode, name = "count") |>
  arrange(event_year, cm_mode)

ggplot(year_mode_counts, aes(x = event_year, y = count, color = cm_mode)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  theme_classic() +
  labs(
    title = "Incident Counts per Year by Mode",
    x = "Year",
    y = "Number of Incidents",
    color = "Mode"
  ) +
  scale_x_continuous(breaks = unique(year_mode_counts$event_year))

ggsave(
  "images/eda/year_counts_bymode.png",
  width = 8,
  height = 6,
  dpi = 300
)

# non-aviation
ggplot(
  filter(year_mode_counts, cm_mode != "Aviation"),
  aes(x = event_year, y = count, color = cm_mode)
) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  theme_classic() +
  labs(
    title = "Incident Counts per Year (Non-Aviation Modes)",
    x = "Year",
    y = "Number of Incidents",
    color = "Mode"
  ) +
  scale_x_continuous(breaks = unique(year_mode_counts$event_year))

ggsave(
  "images/eda/non-aviation-incidents-year-hist.png",
  width = 8,
  height = 6,
  dpi = 300
)

```


Categorical
```{r}
all_data_clean |>
  count(cm_highestInjury) |>
  arrange(desc(n))

ggplot(all_data_clean, aes(x = cm_highestInjury)) +
  geom_bar(fill = "firebrick", color = "white") +
  theme_classic() +
  labs(
    title = "Distribution of Highest Injury Categories",
    x = "Highest Injury",
    y = "Count"
  )

ggsave(
  "../images/eda/injury_cats_dist.png",
  width = 8,
  height = 6,
  dpi = 300
)

all_data_clean |>
  count(cm_mode) |>
  arrange(desc(n))

```

### Excluding Non-Injury Events
```{r}

# injury conversions
injury_df <- all_data_dates |>
  filter(cm_highestInjury != "None")

# histogram by year
ggplot(injury_df, aes(x = event_year)) +
  geom_histogram(binwidth = 1, fill = "steelblue", color = "white") +
  theme_classic() +
  labs(
    title = "Incidents with Injuries per Year (2015-2025)",
    x = "Year",
    y = "Count of Incidents"
  )

ggsave(
  "images/eda/incidents_yearly_hist_injuries.png",
  width = 8,
  height = 6,
  dpi = 300
)


# histogram by month 
ggplot(injury_df, aes(x = event_month)) +
  geom_bar(fill = "steelblue", color = "white") +
  theme_classic() +
  labs(
    title = "Incidents with Injuries per month (2015-2025)",
    x = "Month",
    y = "Count of Incidents"
  )

ggsave(
  "images/eda/incidents_monthly_hist_injuries.png",
  width = 8,
  height = 6,
  dpi = 300
)

# heat map by year and month 
injury_df |>
  count(event_year, event_month) |>
  ggplot(aes(x = event_month, y = factor(event_year), fill = n)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c(option = "C") +
  labs(
    title = "Incidents with Injuries by Month and Year (2015-2025)",
    x = "Month",
    y = "Year",
    fill = "Count"
  ) +
  theme_classic()

ggsave(
  "images/eda/year_month_heatmap_injuries.png",
  width = 8,
  height = 6,
  dpi = 300
)

# hist on year and mode
injuries_year_mode_counts <- injury_df |>
  count(event_year, cm_mode, name = "count") |>
  arrange(event_year, cm_mode)

ggplot(injuries_year_mode_counts, aes(x = event_year, y = count, color = cm_mode)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  theme_classic() +
  labs(
    title = "Incident with Injuries Counts per Year by Mode",
    x = "Year",
    y = "Number of Incidents with Injuries",
    color = "Mode"
  ) +
  scale_x_continuous(breaks = unique(injuries_year_mode_counts$event_year))

ggsave(
  "images/eda/injuries_year_counts_bymode.png",
  width = 8,
  height = 6,
  dpi = 300
)

# non-aviation
ggplot(
  filter(injuries_year_mode_counts, cm_mode != "Aviation"),
  aes(x = event_year, y = count, color = cm_mode)
) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2) +
  theme_classic() +
  labs(
    title = "Incident with Injuries Counts per Year (Non-Aviation Modes)",
    x = "Year",
    y = "Number of Incidents with Injuries",
    color = "Mode"
  ) +
  scale_x_continuous(breaks = unique(injuries_year_mode_counts$event_year))

ggsave(
  "images/eda/injuries-non-aviation-incidents-year-hist.png",
  width = 8,
  height = 6,
  dpi = 300
)

```


## Proximity Analysis
```{r}
# point to base distances

nearest_base <- st_nearest_feature(cases_conus, bases_conus)
nearest_distances <- st_distance(
    cases_conus,
    bases_conus[nearest_base, ]
)
obs_mean_dist <- mean(as.numeric(nearest_distances))
obs_mean_dist

```


```{r}

# compute mean distance
compute_mean_dist <- function(sim_points_sf) {
  # nearest base index
  nearest_idx <- st_nearest_feature(sim_points_sf, bases_conus)
  
  # distance only to nearest base (1 dist per point)
  nearest_d <- st_distance(
    sim_points_sf,
    bases_conus[nearest_idx, ]
  )
  
  mean(as.numeric(nearest_d))
}

# simulation prep list
library(spatstat.geom)

N <- 500   # number of Monte Carlo sims

# Convert study polygon to spatstat window
win <- as.owin(conus_3857)

full_sims_list <- lapply(1:N, function(i) {
  sim_ppp <- rpoint(n = nrow(cases_conus), win = win)
  sim_ppp
})

sim_dists <- lapply(full_sims_list, function(pp) {
  sim_sf <- st_as_sf(pp) %>% st_set_crs(3857)
  compute_mean_dist(sim_sf)
})

```

```{r}
N <- 100
sim_dists <- numeric(N)

# one progress bar
pb <- txtProgressBar(min = 0, max = N, style = 3)

for (i in 1:N) {
  # Generate simulation
  sim_ppp <- rpoint(n = nrow(cases_conus), win = win)
  
  # Convert to sf with CRS
  sim_sf <- st_as_sf(sim_ppp) |> st_set_crs(3857)
  
  # Compute stat
  sim_dists[i] <- compute_mean_dist(sim_sf)
  
  # Progress feedback
  if (i %% 50 == 0) message("Completed ", i, " simulations.")
  setTxtProgressBar(pb, i)
}

close(pb)



```

```{r}

# plot sim vs. observed

sim_df <- tibble(value = unlist(sim_dists))
obs_df <- tibble(value = obs_mean_dist)

ggplot(sim_df, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_mean_dist, linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (meters)"
  )




```


```{r}
# compute p-value
p_value <- mean(sim_df$value <= obs_mean_dist)
p_value

```



# Only CA/OR/WA
combined map
```{r}

# only west coast
westcoast <- us_states |>
  filter(name %in% c("California", "Oregon", "Washington")) |> 
  st_union()

wc_3857 <- st_transform(westcoast, 3857)

# filter
cases_wc <- st_intersection(cases_3857, wc_3857)
bases_wc <- st_intersection(bases_centroids, wc_3857)

mapview(cases_wc) + mapview(bases_wc, col.regions="red")

```

## Proximity Analysis
```{r}
# point to base distances

nearest_base_wc <- st_nearest_feature(cases_wc, bases_wc)
nearest_distances_wc <- st_distance(
    cases_wc,
    bases_wc[nearest_base_wc, ]
)
obs_mean_dist_wc <- mean(as.numeric(nearest_distances_wc))
obs_mean_dist_wc

```


```{r}

# compute mean distance
compute_mean_dist_wc <- function(sim_points_sf) {
  # nearest base index
  nearest_idx_wc <- st_nearest_feature(sim_points_sf, bases_wc)
  
  # distance only to nearest base (1 dist per point)
  nearest_d_wc <- st_distance(
    sim_points_sf,
    bases_wc[nearest_idx_wc, ]
  )
  
  mean(as.numeric(nearest_d_wc))
}

```

```{r}
N <- 100
sim_dists_wc <- numeric(N)
win_wc <- as.owin(wc_3857)

# one progress bar
pb <- txtProgressBar(min = 0, max = N, style = 3)

for (i in 1:N) {
  # Generate simulation
  sim_ppp_wc <- rpoint(n = nrow(cases_wc), win = win_wc)
  # Convert to sf with CRS
  sim_sf_wc <- st_as_sf(sim_ppp_wc) |> st_set_crs(3857)
  # Compute stat
  sim_dists_wc[i] <- compute_mean_dist_wc(sim_sf_wc)
  
  # Progress feedback
  if (i %% 50 == 0) message("Completed ", i, " simulations.")
  setTxtProgressBar(pb, i)
}

close(pb)

```

```{r}

sim_df_wc <- tibble(value = unlist(sim_dists_wc))
obs_df_wc <- tibble(value = obs_mean_dist_wc)

ggplot(sim_df_wc, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_mean_dist_wc, linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base: Pacific West CONUS",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (meters)"
  )




```


```{r}
# compute p-value
p_value_wc <- mean(sim_df_wc$value <= obs_mean_dist_wc)
p_value_wc

```

```{r}
# convert to miles
meters_to_miles <- 0.000621371

sim_df_miles_wc <- sim_df_wc %>% 
  mutate(value = value * meters_to_miles)

obs_dist_miles_wc <- obs_mean_dist_wc * meters_to_miles

ggplot(sim_df_miles_wc, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_dist_miles_wc, 
             linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base WC",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (miles)"
  )

ggsave(
  "images/wc_distance_distribution_miles.png",
  width = 8,
  height = 6,
  dpi = 300
)
```




# Only South (West Central South)
combined map
```{r}

# only west coast
wc_south <- us_states |>
  filter(name %in% c("Texas", "Oklahoma", "Arkansas", "Louisiana")) |> 
  st_union()

wcs_3857 <- st_transform(wc_south, 3857)

# filter
cases_wcs <- st_intersection(cases_3857, wcs_3857)
bases_wcs <- st_intersection(bases_centroids, wcs_3857)

mapview(cases_wcs) + mapview(bases_wcs, col.regions="red")

```

## Proximity Analysis
```{r}
# point to base distances

nearest_base_wcs <- st_nearest_feature(cases_wcs, bases_wcs)
nearest_distances_wcs <- st_distance(
    cases_wcs,
    bases_wcs[nearest_base_wcs, ]
)
obs_mean_dist_wcs <- mean(as.numeric(nearest_distances_wcs))
obs_mean_dist_wcs

# compute mean distance
compute_mean_dist_wcs <- function(sim_points_sf) {
  # nearest base index
  nearest_idx_wcs <- st_nearest_feature(sim_points_sf, bases_wcs)
  
  # distance only to nearest base (1 dist per point)
  nearest_d_wcs <- st_distance(
    sim_points_sf,
    bases_wcs[nearest_idx_wcs, ]
  )
  
  mean(as.numeric(nearest_d_wcs))
}

```


```{r}
N <- 100
sim_dists_wcs <- numeric(N)
win_wcs <- as.owin(wcs_3857)

# one progress bar
pb <- txtProgressBar(min = 0, max = N, style = 3)

for (i in 1:N) {
  # Generate simulation
  sim_ppp_wcs <- rpoint(n = nrow(cases_wcs), win = win_wcs)
  # Convert to sf with CRS
  sim_sf_wcs <- st_as_sf(sim_ppp_wcs) |> st_set_crs(3857)
  # Compute stat
  sim_dists_wcs[i] <- compute_mean_dist_wcs(sim_sf_wcs)
  
  # Progress feedback
  if (i %% 50 == 0) message("Completed ", i, " simulations.")
  setTxtProgressBar(pb, i)
}

close(pb)

```

```{r}

sim_df_wcs <- tibble(value = unlist(sim_dists_wcs))
obs_df_wcs <- tibble(value = obs_mean_dist_wcs)

ggplot(sim_df_wcs, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_mean_dist_wcs, linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base: West South Central Region",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (meters)"
  )

# compute p-value
p_value_wcs <- mean(sim_df_wcs$value <= obs_mean_dist_wcs)
p_value_wcs



```


```{r}
# convert to miles
meters_to_miles <- 0.000621371

sim_df_miles_wcs <- sim_df_wcs %>% 
  mutate(value = value * meters_to_miles)

obs_dist_miles_wcs <- obs_mean_dist_wcs * meters_to_miles

ggplot(sim_df_miles_wcs, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_dist_miles_wcs, 
             linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base WSC",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (miles)"
  )

ggsave(
  "images/wcs_distance_distribution_miles.png",
  width = 8,
  height = 6,
  dpi = 300
)
```



# Generalized

combined map
```{r}
region_analysis <- function(region, region_class)

region_base <- us_states |>
  filter(name %in$ region in region_class)


region_3857 <- st_transform(wc_south, 3857)

# only west coast
wc_south <- us_states |>
  filter(name %in% c("Texas", "Oklahoma", "Arkansas", "Louisiana")) |> 
  st_union()

region_3857

wcs_3857 <- st_transform(wc_south, 3857)

# filter
cases_wcs <- st_intersection(cases_3857, wcs_3857)
bases_wcs <- st_intersection(bases_centroids, wcs_3857)

mapview(cases_wcs) + mapview(bases_wcs, col.regions="red")

```

## Proximity Analysis
```{r}
# point to base distances

nearest_base_wcs <- st_nearest_feature(cases_wcs, bases_wcs)
nearest_distances_wcs <- st_distance(
    cases_wcs,
    bases_wcs[nearest_base_wcs, ]
)
obs_mean_dist_wcs <- mean(as.numeric(nearest_distances_wcs))
obs_mean_dist_wcs

# compute mean distance
compute_mean_dist <- function(sim_points_sf) {
  # nearest base index
  nearest_idx <- st_nearest_feature(sim_points_sf, bases_wcs)
  
  # distance only to nearest base (1 dist per point)
  nearest_d <- st_distance(
    sim_points_sf,
    bases_wcs[nearest_idx, ]
  )
  
  mean(as.numeric(nearest_d))
}

```


```{r}
N <- 100
sim_dists <- numeric(N)
win_wcs <- as.owin(wcs_3857)

# one progress bar
pb <- txtProgressBar(min = 0, max = N, style = 3)

for (i in 1:N) {
  # Generate simulation
  sim_ppp <- rpoint(n = nrow(cases_wcs), win = win_wcs)
  # Convert to sf with CRS
  sim_sf <- st_as_sf(sim_ppp) |> st_set_crs(3857)
  # Compute stat
  sim_dists[i] <- compute_mean_dist(sim_sf)
  
  # Progress feedback
  if (i %% 50 == 0) message("Completed ", i, " simulations.")
  setTxtProgressBar(pb, i)
}

close(pb)

```

```{r}

sim_df <- tibble(value = unlist(sim_dists))
obs_df <- tibble(value = obs_mean_dist_wcs)

ggplot(sim_df, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_mean_dist_wcs, linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base: West South Central Region",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (meters)"
  )

# compute p-value
p_value <- mean(sim_df$value <= obs_mean_dist_wcs)
p_value


```


```{r}
# convert to miles
meters_to_miles <- 0.000621371

sim_df_miles <- sim_df %>% 
  mutate(value = value * meters_to_miles)

obs_dist_miles <- obs_mean_dist_wcs * meters_to_miles

ggplot(sim_df_miles, aes(x = value)) +
  geom_density(fill = "lightblue", alpha = 0.5) +
  geom_vline(xintercept = obs_dist_miles, 
             linetype = "dashed", color = "red") +
  theme_classic() +
  labs(
    title = "Mean Distance from Incidents to Nearest Military Base",
    subtitle = "Observed vs Monte Carlo Null Distribution",
    x = "Mean Distance (miles)"
  )

ggsave(
  "images/wcs_distance_distribution_miles.png",
  width = 8,
  height = 6,
  dpi = 300
)
```





# GENERAL - chat

States lists for regional runs
```{r}

region_states <- list(
  WCS = c("Texas", "Oklahoma", "Arkansas", "Louisiana"),
  WP = c("California", "Oregon", "Washington"),
  WM = c("Montana", "Idaho", "Wyoming", "Nevada", "Utah", "Colorado", "Arizona", "New Mexico"),
  WNC = c("North Dakota", "South Dakota", "Minnesota", "Nebraska", "Kansas", "Iowa", "Kansas", "Missouri"),
  ENC = c("Wisconsin", "Michigan", "Illinois", "Indiana", "Ohio"),
  ESC = c("Kentucky", "Tennessee", "Missippi", "Alabama"),
  SA = c("Florida", "Georgia", "South Carolina", "North Carolina", "Virginia", "West Virginia", "Washington D.C.", "Maryland", "Delaware"),
  MA = c("New York", "Pennsylvania", "New Jersey"),
  NE = c("Connecticut", "Massachussetts", "Vermont", "New Hampshire", "Rhode Island", "Maine")
)


```


```{r}
library(sf)
library(dplyr)
library(spatstat.geom)
library(ggplot2)
library(tibble)

meters_to_miles <- 0.000621371

get_region_states <- function(region_key) {
  region_states[[region_key]]
}


run_region_analysis <- function(
    region_states,
    region_label,
    cases_3857,
    bases_centroids,
    us_states,
    N = 500,
    output_dir = "images/"
) {
  
  message("=== Running analysis for region: ", region_label, " ===")
  
  # -----------------------------
  # 1. Create region polygon
  # -----------------------------
  region_poly <- us_states |>
    filter(name %in% region_states) |>
    st_union() |>
    st_transform(3857)
  
  message("States: ", region_states)
  
  # -----------------------------
  # 2. Clip cases + bases to region
  # -----------------------------
  cases_region <- st_intersection(cases_3857, region_poly)
  bases_region <- st_intersection(bases_centroids, region_poly)
  
  if (nrow(cases_region) == 0) {
    stop("No incident cases found in this region.")
  }
  if (nrow(bases_region) == 0) {
    stop("No bases found in this region.")
  }
  
  message("Cases in region: ", nrow(cases_region))
  message("Bases in region: ", nrow(bases_region))
  
  # -----------------------------
  # 3. Compute observed mean distance
  # -----------------------------
  nearest_idx <- st_nearest_feature(cases_region, bases_region)
  nearest_d <- st_distance(cases_region, bases_region[nearest_idx, ])
  obs_mean_dist <- mean(as.numeric(nearest_d))
  obs_miles <- obs_mean_dist * meters_to_miles
  
  message("Observed mean distance (miles): ", round(obs_miles, 2))
  
  # -----------------------------
  # 4. Monte Carlo Simulations
  # -----------------------------
  win_region <- as.owin(region_poly)
  sim_dists <- numeric(N)
  
  pb <- txtProgressBar(min = 0, max = N, style = 3)
  
  for (i in seq_len(N)) {
    sim_ppp <- rpoint(n = nrow(cases_region), win = win_region)
    sim_sf  <- st_as_sf(sim_ppp) |> st_set_crs(3857)
    
    # Compute simulated mean distance
    nearest_idx_sim <- st_nearest_feature(sim_sf, bases_region)
    d_sim <- st_distance(sim_sf, bases_region[nearest_idx_sim, ])
    sim_dists[i] <- mean(as.numeric(d_sim))
    
    setTxtProgressBar(pb, i)
  }
  close(pb)
  
  # -----------------------------
  # 5. Convert sims to miles
  # -----------------------------
  sim_df <- tibble(value_m = sim_dists)
  sim_df <- sim_df |> mutate(value = value_m * meters_to_miles)
  
  # -----------------------------
  # 6. Compute p-value
  # -----------------------------
  p_value <- mean(sim_df$value <= obs_miles)
  
  message("P-value: ", p_value)
  
  # -----------------------------
  # 7. Plot and save
  # -----------------------------
  p <- ggplot(sim_df, aes(x = value)) +
    geom_density(fill = "lightblue", alpha = 0.5) +
    geom_vline(xintercept = obs_miles,
               color = "red",
               linetype = "dashed",
               linewidth = 1.1) +
    theme_classic() +
    labs(
      title = paste0("Distance to Nearest Base: ", region_label),
      subtitle = paste0("Observed vs Simulated (N=", N, ")"),
      x = "Mean Distance (miles)"
    )
  
  # ensure output directory
  if (!dir.exists(output_dir)) dir.create(output_dir)
  
  output_path <- paste0(output_dir, region_label, "_distance_distribution.png")
  
  ggsave(
    output_path,
    p,
    width = 8,
    height = 6,
    dpi = 300
  )
  
  message("Plot saved to: ", output_path)
  
  # -----------------------------
  # 8. Return results
  # -----------------------------
  return(list(
    region = region_label,
    observed_distance_m = obs_mean_dist,
    observed_distance_miles = obs_miles,
    p_value = p_value,
    plot_path = output_path
  ))
}
```


RUN ABOVE
```{r}

region_keys <- names(region_states)
results_list <- list()

for (region in region_keys){
  message("Running region: ", region)

  results_list[[region]] <- run_region_analysis(
  region_states = get_region_states(region),
  region_label = region,
  cases_3857 = cases_3857,
  bases_centroids = bases_centroids,
  us_states = us_states,
  N = 100,
  output_dir = "images/all/"
)
}

results_df <- bind_rows(results_list)
write_csv(results_df, "data/outputs/region_proximity_results.csv")

 


```

Run for only incidents with injuries
```{r}

injury_cases_3857 <- cases_3857 |>
  filter(cm_highestInjury != "None")

for (region in region_keys){
  message("Running region: ", region)

  results_list[[region]] <- run_region_analysis(
  region_states = get_region_states(region),
  region_label = region,
  cases_3857 = injury_cases_3857,
  bases_centroids = bases_centroids,
  us_states = us_states,
  N = 100,
  output_dir = "images/injury/"
)
}

results_df <- bind_rows(results_list)
write_csv(results_df, "data/outputs/injury_region_proximity_results.csv")
```